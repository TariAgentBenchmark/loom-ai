# 错误码定义

## 概述

本文档定义了LoomAI API中所有可能的错误码及其说明。

## 错误响应格式

所有API错误都遵循统一的响应格式：

```json
{
  "success": false,
  "error": {
    "code": "E001",
    "message": "参数错误",
    "details": "image 字段不能为空",
    "field": "image",           // 可选，指出错误字段
    "retryable": false          // 可选，是否可重试
  },
  "timestamp": "2023-12-01T10:00:00Z",
  "traceId": "trace_123456789"  // 可选，用于问题追踪
}
```

## HTTP状态码

| 状态码 | 说明 | 使用场景 |
|-------|------|----------|
| 200 | OK | 请求成功 |
| 201 | Created | 资源创建成功 |
| 400 | Bad Request | 请求参数错误 |
| 401 | Unauthorized | 未认证或认证失败 |
| 403 | Forbidden | 无权限访问 |
| 404 | Not Found | 资源不存在 |
| 409 | Conflict | 资源冲突 |
| 422 | Unprocessable Entity | 请求格式正确但语义错误 |
| 429 | Too Many Requests | 请求频率超限 |
| 500 | Internal Server Error | 服务器内部错误 |
| 502 | Bad Gateway | 网关错误 |
| 503 | Service Unavailable | 服务不可用 |

## 错误码分类

### 通用错误码 (E000-E099)

| 错误码 | HTTP状态码 | 说明 | 解决方案 |
|-------|-----------|------|----------|
| E001 | 400 | 请求参数错误 | 检查请求参数格式和必填字段 |
| E002 | 400 | JSON格式错误 | 检查请求体JSON格式 |
| E003 | 413 | 请求体过大 | 减少请求数据大小 |
| E004 | 415 | 不支持的媒体类型 | 检查Content-Type头 |
| E005 | 400 | 缺少必填参数 | 补充必填参数 |
| E006 | 400 | 参数值无效 | 检查参数值范围和格式 |
| E007 | 429 | 请求频率超限 | 降低请求频率 |
| E008 | 422 | 数据验证失败 | 检查数据格式和约束 |
| E009 | 500 | 服务器内部错误 | 联系技术支持 |
| E010 | 503 | 服务暂时不可用 | 稍后重试 |

### 认证错误码 (A000-A099)

| 错误码 | HTTP状态码 | 说明 | 解决方案 |
|-------|-----------|------|----------|
| A001 | 400 | 邮箱格式不正确 | 检查邮箱格式 |
| A002 | 400 | 密码长度不足 | 密码至少8位 |
| A003 | 409 | 邮箱已存在 | 使用其他邮箱或直接登录 |
| A004 | 401 | 登录凭据无效 | 检查邮箱和密码 |
| A005 | 401 | Token已过期 | 刷新Token或重新登录 |
| A006 | 401 | Token无效 | 检查Token格式或重新登录 |
| A007 | 400 | 重置令牌无效或已过期 | 重新申请密码重置 |
| A008 | 400 | 当前密码错误 | 检查当前密码 |
| A009 | 400 | 密码确认不一致 | 确保两次密码输入一致 |
| A010 | 429 | 登录尝试过多 | 等待一段时间后再试 |
| A011 | 400 | 验证码错误 | 检查验证码 |
| A012 | 400 | 验证码已过期 | 重新获取验证码 |

### 用户错误码 (U000-U099)

| 错误码 | HTTP状态码 | 说明 | 解决方案 |
|-------|-----------|------|----------|
| U001 | 404 | 用户不存在 | 检查用户ID |
| U002 | 400 | 头像文件格式不支持 | 使用JPG或PNG格式 |
| U003 | 413 | 头像文件过大 | 文件大小不超过5MB |
| U004 | 409 | 昵称已被使用 | 选择其他昵称 |
| U005 | 400 | 手机号格式不正确 | 检查手机号格式 |
| U006 | 403 | 账户已被暂停 | 联系客服处理 |
| U007 | 400 | 密码验证失败 | 检查密码 |
| U008 | 400 | 注销确认文本不正确 | 输入正确的确认文本 |
| U009 | 400 | API密钥数量已达上限 | 删除不用的密钥 |
| U010 | 403 | 权限不足 | 联系管理员开通权限 |
| U011 | 400 | 手机号已绑定其他账户 | 使用其他手机号 |
| U012 | 400 | 邮箱验证失败 | 完成邮箱验证 |

### 图片处理错误码 (P000-P099)

| 错误码 | HTTP状态码 | 说明 | 解决方案 |
|-------|-----------|------|----------|
| P001 | 400 | 图片文件不能为空 | 上传图片文件 |
| P002 | 415 | 不支持的图片格式 | 使用PNG、JPG、GIF、BMP格式 |
| P003 | 413 | 图片文件过大 | 文件大小不超过50MB |
| P004 | 403 | 算力不足 | 充值算力或购买套餐 |
| P005 | 404 | 任务不存在 | 检查任务ID |
| P006 | 422 | 任务处理失败 | 检查图片质量，重新尝试 |
| P007 | 400 | 参数格式错误 | 检查处理参数格式 |
| P008 | 400 | 图片分辨率过低 | 使用更高分辨率的图片 |
| P009 | 500 | 服务器处理异常 | 联系技术支持 |
| P010 | 409 | 任务已存在 | 避免重复提交 |
| P011 | 422 | 图片内容不适合处理 | 选择其他图片 |
| P012 | 503 | 处理队列已满 | 稍后重试 |
| P013 | 408 | 处理超时 | 重新提交任务 |
| P014 | 400 | 图片损坏或无法读取 | 检查图片文件完整性 |

### 算力错误码 (C000-C099)

| 错误码 | HTTP状态码 | 说明 | 解决方案 |
|-------|-----------|------|----------|
| C001 | 403 | 算力不足 | 充值算力或购买套餐 |
| C002 | 400 | 转赠数量超过余额 | 调整转赠数量 |
| C003 | 404 | 转赠对象不存在 | 检查接收方邮箱 |
| C004 | 400 | 不能向自己转赠算力 | 选择其他接收方 |
| C005 | 400 | 预警阈值设置无效 | 设置合理的阈值 |
| C006 | 404 | 算力记录不存在 | 检查记录ID |
| C007 | 403 | 转赠功能已禁用 | 联系客服开通 |
| C008 | 400 | 单次转赠数量超限 | 减少转赠数量 |
| C009 | 400 | 今日转赠次数已达上限 | 明日再试 |
| C010 | 400 | 算力余额异常 | 联系客服处理 |

### 支付错误码 (PAY000-PAY099)

| 错误码 | HTTP状态码 | 说明 | 解决方案 |
|-------|-----------|------|----------|
| PAY001 | 404 | 套餐不存在 | 选择有效的套餐 |
| PAY002 | 400 | 支付方式不支持 | 选择其他支付方式 |
| PAY003 | 409 | 订单已支付 | 避免重复支付 |
| PAY004 | 404 | 订单不存在 | 检查订单ID |
| PAY005 | 400 | 订单已过期 | 重新创建订单 |
| PAY006 | 404 | 优惠券不存在 | 检查优惠券码 |
| PAY007 | 400 | 优惠券已过期 | 使用有效的优惠券 |
| PAY008 | 400 | 优惠券不适用当前套餐 | 选择适用的套餐 |
| PAY009 | 409 | 退款申请已存在 | 避免重复申请 |
| PAY010 | 400 | 该订单不支持退款 | 查看退款政策 |
| PAY011 | 422 | 支付失败 | 检查支付信息或联系银行 |
| PAY012 | 404 | 发票不存在 | 确认订单已支付 |
| PAY013 | 400 | 优惠券使用条件不满足 | 检查使用条件 |
| PAY014 | 400 | 套餐购买数量超限 | 调整购买数量 |

### 历史记录错误码 (H000-H099)

| 错误码 | HTTP状态码 | 说明 | 解决方案 |
|-------|-----------|------|----------|
| H001 | 404 | 历史记录不存在 | 检查记录ID |
| H002 | 410 | 文件已过期或不可下载 | 文件已被清理 |
| H003 | 400 | 批量操作数量超限 | 减少操作数量 |
| H004 | 400 | 标签数量超限 | 最多10个标签 |
| H005 | 400 | 备注长度超限 | 备注不超过500字符 |
| H006 | 410 | 分享已过期 | 重新生成分享链接 |
| H007 | 403 | 分享密码错误 | 输入正确密码 |
| H008 | 403 | 无权限访问该记录 | 确认记录归属 |
| H009 | 500 | 文件下载失败 | 重试或联系技术支持 |
| H010 | 500 | 分享链接生成失败 | 重试或联系技术支持 |
| H011 | 400 | 标签名称无效 | 使用有效的标签名称 |
| H012 | 409 | 记录已被删除 | 记录不存在 |

## 重试策略

### 可重试的错误

以下错误码支持客户端重试：
- E007 (请求频率超限) - 使用指数退避重试
- E010 (服务暂时不可用) - 短暂延迟后重试
- P009 (服务器处理异常) - 最多重试3次
- P012 (处理队列已满) - 延迟重试
- P013 (处理超时) - 可重新提交
- H009 (文件下载失败) - 短暂延迟后重试

### 重试建议

1. **指数退避**: 重试间隔按2^n秒递增（1s, 2s, 4s, 8s...）
2. **最大重试次数**: 建议不超过3次
3. **超时设置**: 单次请求超时时间建议30-60秒
4. **幂等性**: 确保重试操作的幂等性

## 错误处理最佳实践

### 客户端处理建议

1. **统一错误处理**: 建立统一的错误处理机制
2. **用户友好提示**: 将技术错误转换为用户易懂的提示
3. **日志记录**: 记录错误详情和traceId便于排查
4. **降级策略**: 对于非关键功能实施降级策略

### 示例错误处理代码

```javascript
// JavaScript示例
function handleApiError(error) {
  const { code, message, details, retryable } = error;
  
  switch(code) {
    case 'A005': // Token已过期
      refreshToken();
      break;
    case 'P004': // 算力不足
      showUpgradeModal();
      break;
    case 'P012': // 处理队列已满
      if (retryable) {
        setTimeout(() => retryRequest(), 5000);
      }
      break;
    default:
      showErrorMessage(message);
  }
}
```

## 常见问题

### Q: 如何判断是否需要重试？
A: 检查响应中的 `retryable` 字段，或根据HTTP状态码判断（5xx通常可重试）。

### Q: Token过期如何处理？
A: 收到A005错误码时，使用refresh token获取新的access token，然后重试原请求。

### Q: 如何处理算力不足？
A: 收到P004错误码时，引导用户充值算力或购买会员套餐。

### Q: 文件上传失败如何处理？
A: 检查文件格式、大小是否符合要求，网络是否稳定，必要时重试上传。

### Q: 如何获取技术支持？
A: 记录错误的traceId，通过客服邮箱tech@loom-ai.com联系技术支持。
